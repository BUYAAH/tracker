{% extends 'base.html' %}

{% block title %}Family GPS Tracker{% endblock %}

{% block content %}
<div id="content" style="height: 800px; width: 480px; margin: 0 auto;">
    <!-- Family Members Status - Top 300px -->
    <div style="height: 300px; padding: 20px; background-color: white; border-radius: 8px; margin-bottom: 10px; border: 1px solid #dee2e6;">
        {% for location in locations %}
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <span class="badge bg-primary me-3" style="font-size: 14px;">{{ location.user.first_name|first|upper|default:location.user.username|first|upper }}</span>
                <strong style="font-size: 18px;">{{ location.user.first_name|default:location.user.username }}</strong>
            </div>
            <small class="text-muted" style="font-size: 14px;">{{ location.timestamp|timesince }} ago</small>
        </div>
        {% empty %}
        <p class="text-muted text-center mt-5" style="font-size: 16px;">No family members online yet.<br>Start OwnTracks to see locations!</p>
        {% endfor %}
    </div>
    
    <!-- Map - Bottom 500px -->
    <div id="map" style="height: 500px; border-radius: 8px;"></div>
</div>

<script>
    // Initialize the map centered on Denmark
    var map = L.map('map').setView([55.6761, 12.5683], 7);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Custom icons for family members
    var momIcon = L.divIcon({
        html: '<div style="background-color: #ff69b4; color: white; border-radius: 50%; width: 25px; height: 25px; text-align: center; line-height: 25px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">M</div>',
        iconSize: [25, 25],
        className: 'custom-div-icon'
    });

    var dadIcon = L.divIcon({
        html: '<div style="background-color: #0d6efd; color: white; border-radius: 50%; width: 25px; height: 25px; text-align: center; line-height: 25px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">D</div>',
        iconSize: [25, 25],
        className: 'custom-div-icon'
    });

    // Real family member locations from database
    var familyMembers = [
        {% for location in locations %}
        {
            name: "{{ location.user.first_name|default:location.user.username }}",
            lat: {{ location.latitude }},
            lng: {{ location.longitude }},
            location: "{{ location.latitude|floatformat:4 }}, {{ location.longitude|floatformat:4 }}",
            lastSeen: "{{ location.timestamp|timesince }} ago",
            accuracy: {{ location.accuracy|default:0 }},
            battery: {{ location.battery|default:0 }},
            icon: {% cycle 'momIcon' 'dadIcon' %}
        }{% if not forloop.last %},{% endif %}
        {% empty %}
        // No locations yet - show default Denmark view
        {% endfor %}
    ];

    // Add markers for each family member and collect coordinates
    var markers = [];
    familyMembers.forEach(function(member) {
        var marker = L.marker([member.lat, member.lng], {icon: member.icon}).addTo(map);
        markers.push(marker);
        
        marker.bindPopup(`
            <div class="card" style="border: none; min-width: 200px;">
                <div class="card-body p-2">
                    <h6 class="card-title mb-2">${member.name}</h6>
                    <p class="card-text mb-1"><small><strong>Location:</strong> ${member.location}</small></p>
                    <p class="card-text mb-1"><small><strong>Last seen:</strong> ${member.lastSeen}</small></p>
                    <p class="card-text mb-1"><small><strong>Accuracy:</strong> ±${member.accuracy}m</small></p>
                    ${member.battery > 0 ? `<p class="card-text mb-0"><small><strong>Battery:</strong> ${member.battery}%</small></p>` : ''}
                </div>
            </div>
        `);
    });

    // Auto-zoom to fit all family members
    if (markers.length > 0) {
        var group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds(), {padding: [20, 20]});
    }
</script>
{% endblock %}