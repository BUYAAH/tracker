{% extends 'base.html' %}

{% block title %}Family GPS Tracker{% endblock %}

{% block content %}
<div id="content" style="height: 800px; width: 480px; margin: 0 auto;">
    <!-- Family Members Status - Top 300px -->
    <div style="height: 300px; padding: 20px; background-color: white; border-radius: 8px; margin-bottom: 10px; border: 1px solid #dee2e6;">
        {% for location in locations %}
        <div class="d-flex justify-content-between align-items-center mb-4">
            <strong style="font-size: 24px;">{{ location.user.first_name|default:location.user.username }}</strong>
            <span style="font-size: 18px; color: black;">{{ location.timestamp|timesince }} ago</span>
        </div>
        {% empty %}
        <p class="text-muted text-center mt-5" style="font-size: 20px;">No family members online yet.<br>Start OwnTracks to see locations!</p>
        {% endfor %}
    </div>
    
    <!-- Map - Bottom 500px -->
    <div id="map" style="height: 500px; border-radius: 8px;"></div>
</div>

<script>
    // Initialize the map centered on Denmark
    var map = L.map('map').setView([55.6761, 12.5683], 7);

    // Try OpenStreetMap tiles with fallback
    var tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/x8AAwMCAO+ip1sAAAAASUVORK5CYII=' // 1x1 transparent pixel
    }).addTo(map);
    
    // Add a fallback background for when tiles fail
    map.on('tileerror', function(e) {
        console.log('Tile failed to load, using fallback');
        // Set a simple background color for the map container
        document.getElementById('map').style.backgroundColor = '#e6f3ff';
    });
    
    // After 3 seconds, if no tiles loaded, show a simple background with grid
    setTimeout(function() {
        var mapElement = document.getElementById('map');
        if (!mapElement.querySelector('.leaflet-tile-loaded')) {
            mapElement.style.background = 'linear-gradient(90deg, #e6f3ff 50%, #f0f8ff 50%), linear-gradient(#e6f3ff 50%, #f0f8ff 50%)';
            mapElement.style.backgroundSize = '20px 20px';
        }
    }, 3000);

    // Custom icons for family members
    var momIcon = L.divIcon({
        html: '<div style="background-color: #ff69b4; color: white; border-radius: 50%; width: 25px; height: 25px; text-align: center; line-height: 25px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">M</div>',
        iconSize: [25, 25],
        className: 'custom-div-icon'
    });

    var dadIcon = L.divIcon({
        html: '<div style="background-color: #0d6efd; color: white; border-radius: 50%; width: 25px; height: 25px; text-align: center; line-height: 25px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">D</div>',
        iconSize: [25, 25],
        className: 'custom-div-icon'
    });

    // Real family member locations from database
    var familyMembers = [
        {% for location in locations %}
        {
            name: "{{ location.user.first_name|default:location.user.username }}",
            lat: {{ location.latitude }},
            lng: {{ location.longitude }},
            location: "{{ location.latitude|floatformat:4 }}, {{ location.longitude|floatformat:4 }}",
            lastSeen: "{{ location.timestamp|timesince }} ago",
            accuracy: {{ location.accuracy|default:0 }},
            battery: {{ location.battery|default:0 }},
            icon: {% cycle 'momIcon' 'dadIcon' %}
        }{% if not forloop.last %},{% endif %}
        {% empty %}
        // No locations yet - show default Denmark view
        {% endfor %}
    ];

    // Add markers for each family member and collect coordinates
    var markers = [];
    familyMembers.forEach(function(member) {
        var marker = L.marker([member.lat, member.lng], {icon: member.icon}).addTo(map);
        markers.push(marker);
        
        marker.bindPopup(`
            <div class="card" style="border: none; min-width: 200px;">
                <div class="card-body p-2">
                    <h6 class="card-title mb-2">${member.name}</h6>
                    <p class="card-text mb-1"><small><strong>Location:</strong> ${member.location}</small></p>
                    <p class="card-text mb-1"><small><strong>Last seen:</strong> ${member.lastSeen}</small></p>
                    <p class="card-text mb-1"><small><strong>Accuracy:</strong> ±${member.accuracy}m</small></p>
                    ${member.battery > 0 ? `<p class="card-text mb-0"><small><strong>Battery:</strong> ${member.battery}%</small></p>` : ''}
                </div>
            </div>
        `);
    });

    // Auto-zoom to fit all family members
    if (markers.length > 0) {
        var group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds(), {padding: [20, 20]});
    }
</script>
{% endblock %}